{"version":3,"file":"util.js","sourceRoot":"","sources":["../../../src/core/util.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Grab bag of utility functions used across the code.\n */\nimport { FileSystem, BFSOneArgCallback, FileSystemConstructor } from './file_system';\nimport { ErrorCode, ApiError } from './api_error';\nimport levenshtein from './levenshtein';\nimport * as path from 'path';\nimport Cred from './cred';\nimport { Buffer } from 'buffer';\n\nexport function deprecationMessage(print: boolean, fsName: string, opts: any): void {\n\tif (print) {\n\t\t// tslint:disable-next-line:no-console\n\t\tconsole.warn(\n\t\t\t`[${fsName}] Direct file system constructor usage is deprecated for this file system, and will be removed in the next major version. Please use the '${fsName}.Create(${JSON.stringify(\n\t\t\t\topts\n\t\t\t)}, callback)' method instead. See https://github.com/jvilk/BrowserFS/issues/176 for more details.`\n\t\t);\n\t\t// tslint:enable-next-line:no-console\n\t}\n}\n\n/**\n * Checks for any IE version, including IE11 which removed MSIE from the\n * userAgent string.\n * @hidden\n */\nexport const isIE: boolean = typeof navigator !== 'undefined' && !!(/(msie) ([\\w.]+)/.exec(navigator.userAgent.toLowerCase()) || navigator.userAgent.indexOf('Trident') !== -1);\n\n/**\n * Check if we're in a web worker.\n * @hidden\n */\nexport const isWebWorker: boolean = typeof window === 'undefined';\n\n/**\n * Throws an exception. Called on code paths that should be impossible.\n * @hidden\n */\nexport function fail() {\n\tthrow new Error('BFS has reached an impossible code path; please file a bug.');\n}\n\n/**\n * Synchronous recursive makedir.\n * @hidden\n */\nexport function mkdirpSync(p: string, mode: number, cred: Cred, fs: FileSystem): void {\n\tif (!fs.existsSync(p, cred)) {\n\t\tmkdirpSync(path.dirname(p), mode, cred, fs);\n\t\tfs.mkdirSync(p, mode, cred);\n\t}\n}\n\n/**\n * Converts a buffer into an array buffer. Attempts to do so in a\n * zero-copy manner, e.g. the array references the same memory.\n * @hidden\n */\nexport function buffer2ArrayBuffer(buff: Buffer): ArrayBuffer | SharedArrayBuffer {\n\tconst u8 = buffer2Uint8array(buff),\n\t\tu8offset = u8.byteOffset,\n\t\tu8Len = u8.byteLength;\n\tif (u8offset === 0 && u8Len === u8.buffer.byteLength) {\n\t\treturn u8.buffer;\n\t} else {\n\t\treturn u8.buffer.slice(u8offset, u8offset + u8Len);\n\t}\n}\n\n/**\n * Converts a buffer into a Uint8Array. Attempts to do so in a\n * zero-copy manner, e.g. the array references the same memory.\n * @hidden\n */\nexport function buffer2Uint8array(buff: Buffer): Uint8Array {\n\tif (buff instanceof Uint8Array) {\n\t\t// BFS & Node v4.0 buffers *are* Uint8Arrays.\n\t\treturn <any>buff;\n\t} else {\n\t\t// Uint8Arrays can be constructed from arrayish numbers.\n\t\t// At this point, we assume this isn't a BFS array.\n\t\treturn new Uint8Array(buff);\n\t}\n}\n\n/**\n * Converts the given Uint8Array into a Buffer. Attempts to be zero-copy.\n * @hidden\n */\nexport function uint8Array2Buffer(u8: Uint8Array): Buffer {\n\tif (u8 instanceof Buffer) {\n\t\treturn u8;\n\t} else if (u8.byteOffset === 0 && u8.byteLength === u8.buffer.byteLength) {\n\t\treturn arrayBuffer2Buffer(u8.buffer);\n\t} else {\n\t\treturn Buffer.from(<ArrayBuffer>u8.buffer, u8.byteOffset, u8.byteLength);\n\t}\n}\n\n/**\n * Converts the given array buffer into a Buffer. Attempts to be\n * zero-copy.\n * @hidden\n */\nexport function arrayBuffer2Buffer(ab: ArrayBuffer | SharedArrayBuffer): Buffer {\n\treturn Buffer.from(<ArrayBuffer>ab);\n}\n\n/**\n * Copies a slice of the given buffer\n * @hidden\n */\nexport function copyingSlice(buff: Buffer, start: number = 0, end = buff.length): Buffer {\n\tif (start < 0 || end < 0 || end > buff.length || start > end) {\n\t\tthrow new TypeError(`Invalid slice bounds on buffer of length ${buff.length}: [${start}, ${end}]`);\n\t}\n\tif (buff.length === 0) {\n\t\t// Avoid s0 corner case in ArrayBuffer case.\n\t\treturn emptyBuffer();\n\t} else {\n\t\tconst u8 = buffer2Uint8array(buff),\n\t\t\ts0 = buff[0],\n\t\t\tnewS0 = (s0 + 1) % 0xff;\n\n\t\tbuff[0] = newS0;\n\t\tif (u8[0] === newS0) {\n\t\t\t// Same memory. Revert & copy.\n\t\t\tu8[0] = s0;\n\t\t\treturn uint8Array2Buffer(u8.slice(start, end));\n\t\t} else {\n\t\t\t// Revert.\n\t\t\tbuff[0] = s0;\n\t\t\treturn uint8Array2Buffer(u8.subarray(start, end));\n\t\t}\n\t}\n}\n\n/**\n * @hidden\n */\nlet emptyBuff: Buffer | null = null;\n/**\n * Returns an empty buffer.\n * @hidden\n */\nexport function emptyBuffer(): Buffer {\n\tif (emptyBuff) {\n\t\treturn emptyBuff;\n\t}\n\treturn (emptyBuff = Buffer.alloc(0));\n}\n\n/**\n * Option validator for a Buffer file system option.\n * @hidden\n */\nexport function bufferValidator(v: object, cb: BFSOneArgCallback): void {\n\tif (Buffer.isBuffer(v)) {\n\t\tcb();\n\t} else {\n\t\tcb(new ApiError(ErrorCode.EINVAL, `option must be a Buffer.`));\n\t}\n}\n\n/**\n * Checks that the given options object is valid for the file system options.\n * @hidden\n */\nexport function checkOptions(fsType: FileSystemConstructor, opts: any, cb: BFSOneArgCallback): void {\n\tconst optsInfo = fsType.Options;\n\tconst fsName = fsType.Name;\n\n\tlet pendingValidators = 0;\n\tlet callbackCalled = false;\n\tlet loopEnded = false;\n\tfunction validatorCallback(e?: ApiError): void {\n\t\tif (!callbackCalled) {\n\t\t\tif (e) {\n\t\t\t\tcallbackCalled = true;\n\t\t\t\tcb(e);\n\t\t\t}\n\t\t\tpendingValidators--;\n\t\t\tif (pendingValidators === 0 && loopEnded) {\n\t\t\t\tcb();\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check for required options.\n\tfor (const optName in optsInfo) {\n\t\tif (Object.prototype.hasOwnProperty.call(optsInfo, optName)) {\n\t\t\tconst opt = optsInfo[optName];\n\t\t\tconst providedValue = opts && opts[optName];\n\n\t\t\tif (providedValue === undefined || providedValue === null) {\n\t\t\t\tif (!opt.optional) {\n\t\t\t\t\t// Required option, not provided.\n\t\t\t\t\t// Any incorrect options provided? Which ones are close to the provided one?\n\t\t\t\t\t// (edit distance 5 === close)\n\t\t\t\t\tconst incorrectOptions = Object.keys(opts)\n\t\t\t\t\t\t.filter(o => !(o in optsInfo))\n\t\t\t\t\t\t.map((a: string) => {\n\t\t\t\t\t\t\treturn { str: a, distance: levenshtein(optName, a) };\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.filter(o => o.distance < 5)\n\t\t\t\t\t\t.sort((a, b) => a.distance - b.distance);\n\t\t\t\t\t// Validators may be synchronous.\n\t\t\t\t\tif (callbackCalled) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tcallbackCalled = true;\n\t\t\t\t\treturn cb(\n\t\t\t\t\t\tnew ApiError(\n\t\t\t\t\t\t\tErrorCode.EINVAL,\n\t\t\t\t\t\t\t`[${fsName}] Required option '${optName}' not provided.${\n\t\t\t\t\t\t\t\tincorrectOptions.length > 0 ? ` You provided unrecognized option '${incorrectOptions[0].str}'; perhaps you meant to type '${optName}'.` : ''\n\t\t\t\t\t\t\t}\\nOption description: ${opt.description}`\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t// Else: Optional option, not provided. That is OK.\n\t\t\t} else {\n\t\t\t\t// Option provided! Check type.\n\t\t\t\tlet typeMatches = false;\n\t\t\t\tif (Array.isArray(opt.type)) {\n\t\t\t\t\ttypeMatches = opt.type.indexOf(typeof providedValue) !== -1;\n\t\t\t\t} else {\n\t\t\t\t\ttypeMatches = typeof providedValue === opt.type;\n\t\t\t\t}\n\t\t\t\tif (!typeMatches) {\n\t\t\t\t\t// Validators may be synchronous.\n\t\t\t\t\tif (callbackCalled) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tcallbackCalled = true;\n\t\t\t\t\treturn cb(\n\t\t\t\t\t\tnew ApiError(\n\t\t\t\t\t\t\tErrorCode.EINVAL,\n\t\t\t\t\t\t\t`[${fsName}] Value provided for option ${optName} is not the proper type. Expected ${\n\t\t\t\t\t\t\t\tArray.isArray(opt.type) ? `one of {${opt.type.join(', ')}}` : opt.type\n\t\t\t\t\t\t\t}, but received ${typeof providedValue}\\nOption description: ${opt.description}`\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t} else if (opt.validator) {\n\t\t\t\t\tpendingValidators++;\n\t\t\t\t\topt.validator(providedValue, validatorCallback);\n\t\t\t\t}\n\t\t\t\t// Otherwise: All good!\n\t\t\t}\n\t\t}\n\t}\n\tloopEnded = true;\n\tif (pendingValidators === 0 && !callbackCalled) {\n\t\tcb();\n\t}\n}\n"]}